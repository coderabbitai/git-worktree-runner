#compdef _git-gtr git-gtr

# Register gtr as a git subcommand for completion
zstyle ':completion:*:*:git:*' user-commands gtr:'Git worktree management'

# Zsh completion for git gtr

_git-gtr() {
  # Note: When called via 'git gtr', the words array is [git, gtr, <command>, ...]
  # This matches how git's completion system passes context to subcommand completions

  local -a commands
  commands=(
    'new:Create a new worktree'
    'go:Navigate to worktree'
    'rm:Remove worktree(s)'
    'editor:Open worktree in editor'
    'ai:Start AI coding tool'
    'ls:List all worktrees'
    'list:List all worktrees'
    'clean:Remove stale worktrees'
    'doctor:Health check'
    'adapter:List available adapters'
    'config:Manage configuration'
    'version:Show version'
    'help:Show help'
  )

  local -a branches all_options
  # Get branch names
  branches=(${(f)"$(git branch --format='%(refname:short)' 2>/dev/null)"})
  # Add special ID '1' for main repo
  all_options=("1" "${branches[@]}")

  # Complete the gtr subcommand (new, go, editor, etc.)
  if (( CURRENT == 3 )); then
    _describe 'commands' commands
  # Complete arguments to the subcommand
  elif (( CURRENT == 4 )); then
    case "$words[3]" in
      go|editor|ai|rm)
        _describe 'branch names' all_options
        ;;
      new)
        _arguments \
          '--from[Base ref]:ref:' \
          '--track[Track mode]:mode:(auto remote local none)' \
          '--no-copy[Skip file copying]' \
          '--no-fetch[Skip git fetch]' \
          '--force[Allow same branch in multiple worktrees]' \
          '--name[Custom folder name suffix]:name:' \
          '--yes[Non-interactive mode]'
        ;;
      config)
        _values 'config action' get set add unset
        ;;
    esac
  # Complete subsequent arguments
  elif (( CURRENT >= 5 )); then
    case "$words[3]" in
      rm)
        _arguments \
          '--delete-branch[Delete branch]' \
          '--force[Force removal even if dirty]' \
          '--yes[Non-interactive mode]'
        ;;
      config)
        case "$words[4]" in
          get|set|add|unset)
            _values 'config key' \
              'gtr.worktrees.dir' \
              'gtr.worktrees.prefix' \
              'gtr.defaultBranch' \
              'gtr.editor.default' \
              'gtr.ai.default' \
              'gtr.copy.include' \
              'gtr.copy.exclude' \
              'gtr.hook.postCreate' \
              'gtr.hook.postRemove'
            ;;
        esac
        ;;
    esac
  fi
}

_git-gtr "$@"
