#compdef gtr
# Zsh completion for gtr

_gtr() {
  local -a commands
  commands=(
    'new:Create a new worktree'
    'go:Navigate to worktree'
    'rm:Remove worktree(s)'
    'open:Open worktree in editor'
    'ai:Start AI coding tool'
    'ls:List all worktrees'
    'list:List all worktrees'
    'clean:Remove stale worktrees'
    'doctor:Health check'
    'adapter:List available adapters'
    'config:Manage configuration'
    'version:Show version'
    'help:Show help'
  )

  local -a worktree_ids branches all_options
  # Use gtr list --ids for config-aware completion
  worktree_ids=(${(f)"$(command gtr list --ids 2>/dev/null)"})
  # Get branch names
  branches=(${(f)"$(git branch --format='%(refname:short)' 2>/dev/null)"})
  # Combine IDs and branches
  all_options=("${worktree_ids[@]}" "${branches[@]}")

  if (( CURRENT == 2 )); then
    _describe 'commands' commands
  elif (( CURRENT == 3 )); then
    case "$words[2]" in
      go|open|ai|rm)
        _describe 'worktree IDs or branches' all_options
        ;;
      new)
        _arguments \
          '--id[Worktree ID]:id:' \
          '--from[Base ref]:ref:' \
          '--track[Track mode]:mode:(auto remote local none)' \
          '--no-copy[Skip file copying]' \
          '--no-fetch[Skip git fetch]' \
          '--yes[Non-interactive mode]'
        ;;
      config)
        _values 'config action' get set unset
        ;;
    esac
  elif (( CURRENT >= 4 )); then
    case "$words[2]" in
      rm)
        _arguments \
          '--delete-branch[Delete branch]' \
          '--force[Force removal even if dirty]' \
          '--yes[Non-interactive mode]'
        ;;
      config)
        case "$words[3]" in
          get|set|unset)
            _values 'config key' \
              'gtr.worktrees.dir' \
              'gtr.worktrees.prefix' \
              'gtr.worktrees.startId' \
              'gtr.defaultBranch' \
              'gtr.editor.default' \
              'gtr.ai.default' \
              'gtr.copy.include' \
              'gtr.copy.exclude' \
              'gtr.hook.postCreate' \
              'gtr.hook.postRemove'
            ;;
        esac
        ;;
    esac
  fi
}

_gtr "$@"
